### Integrate Lynx with Existing Apps (Web)

import { PackageManagerTabs, Steps } from '@theme';
import { Info } from '@lynx';

<Info title="Lynx for Web">
  Lynx for Web implements the Lynx engine in web browsers. With Lynx for Web,
  you can easily integrate Lynx apps into any existing web project, regardless
  of whether the project uses React, Vue, Svelte, or plain HTML.
</Info>

## 1. Build web artifact

We need you to have read and created a Lynx project according to [Quick Start](/guide/start/quick-start).

<Steps>

### Add web configuration

1. Enter the previously created Lynx project:

```bash
cd <lynx-project-name>
```

2. Add web configuration (`environments.web`) to `lynx.config.ts`:

```ts
import { defineConfig } from '@lynx-js/rspeedy';
import { pluginReactLynx } from '@lynx-js/react-rsbuild-plugin';

export default defineConfig({
  plugins: [pluginReactLynx()],
  environments: {
    web: {
      output: {
        assetPrefix: '/',
      },
    },
    lynx: {},
  },
});
```

### Build

Run:

<PackageManagerTabs command="run build" />

You will see an additional `dist/main.web.bundle` file in this project, which is the final web build artifact.

</Steps>

## 2. Integrate with a new web project

Now that you have a Lynx for Web build artifact, we need to create a web project to use it. Here we use Rsbuild.

<Steps>

### Create a web project

Create a new project at the same level as the Lynx project above and run:

<PackageManagerTabs command="create rsbuild@latest" />

Follow the prompts to create a React project.

### Configure the project

1. Navigate to the created project:

```bash
cd <web-project-name>
```

2. Install dependencies

<PackageManagerTabs command="install @lynx-js/web-core @lynx-js/web-elements" />

3. Import these dependencies in `src/app.tsx`

```tsx
import './App.css';
import '@lynx-js/web-core/index.css';
import '@lynx-js/web-elements/index.css';
import '@lynx-js/web-core';
import '@lynx-js/web-elements/all';

const App = () => {
  return (
    <lynx-view
      style={{ height: '100vh', width: '100vw' }}
      url="/main.web.bundle"
    ></lynx-view>
  );
};

export default App;
```

4. Update `rsbuild.config.ts`

:::warning
`server.publicDir` needs to be replaced with your actual Lynx project path.
:::

```ts
import { defineConfig } from '@rsbuild/core';
import { pluginReact } from '@rsbuild/plugin-react';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export default defineConfig({
  plugins: [pluginReact()],
  server: {
    publicDir: [
      {
        name: path.join(
          __dirname,
          '../',
          // Please replace this with your actual Lynx project name
          'lynx-project',
          'dist',
        ),
      },
    ],
  },
});
```

### Start the project

Run:

<PackageManagerTabs command="run dev" />

Visit `http://localhost:3000` to see your Lynx application.

</Steps>

## 3. API Reference

After completing the above integration, you can achieve more flexible interaction control through the APIs provided by Lynx for Web. Here is a detailed description of the core APIs:

### 3.1 lynx-view

#### 3.1.1 Attributes

| Name                        | Required | Description                                                                                                                                           |
| :-------------------------- | :------- | :---------------------------------------------------------------------------------------------------------------------------------------------------- |
| url                         | Yes      | URL of the Rspeedy output (URLs of other chunks will be automatically injected and launched during compilation)                                       |
| globalProps                 | No       | [GlobalProps](/api/lynx-api/lynx/lynx-global-props.mdx) for card initialization                                                                       |
| initData                    | No       | InitData for card initialization                                                                                                                      |
| overrideLynxTagToHTMLTagMap | No       | Custom mapping relationship from Lynx tags to HTML tags. React Components are not supported, only HTMLElements (can be web components or native tags) |

#### 3.2 Properties

##### 3.2.1 nativeModulesMap

Custom [NativeModule](/guide/use-native-modules) where key is the module name and value is the module implementation (an ESM URL):

```ts
type NativeModulesMap = Record<string, string>;
```

Example:

```ts
const nativeModulesMap = {
  CustomModule: URL.createObjectURL(
    new Blob(
      [
        `export default function(NativeModules, NativeModulesCall) {
    return {
      async getColor(data, callback) {
        const color = await NativeModulesCall('getColor', data);
        callback(color);
      },
    }
  };`,
      ],
      { type: 'text/javascript' },
    ),
  ),
};
lynxView.nativeModulesMap = nativeModulesMap;
```

##### 3.2.2 onNativeModulesCall

Entry point for handling NativeModules (JSB, etc.) related calls:

```ts
(name: string, data: any, moduleName: string) => Promise<any> | any;
```

Example:

```ts
// Handle NativeModule.bridge.call('request')
lynxView.onNativeModulesCall = (name, data, moduleName) => {
  if (moduleName === 'bridge') {
    if (name === 'request') {
      // ...

      // return data will be automatically processed as callback data
      return {};
    }
  }
};
```

##### 3.2.3 customTemplateLoader

Allows users to implement custom template loading functionality (default is fetch):

```ts
lynxView.customTemplateLoader = (url) => {
  return await(
    await fetch(url, {
      method: 'GET',
    }),
  ).json();
};
```

#### 3.3 Events

##### 3.3.1 error

Error message notification:

```ts
type LynxError = CustomEvent<{
  error: Error;
  sourceMap: {
    offset: {
      // Line offset
      line: number;
      // Column offset
      col: number;
    };
  };
  release: string;
  fileName: 'lepus.js' | 'app-service.js';
}>;

lynxView.addEventListener('error', (err: LynxError) => {
  // ...
});
```

#### 3.4 Methods

##### 3.4.1 updateData

[See details](/api/lynx-native-api/lynx-view/update-meta-data.mdx)

```ts
export type Cloneable<T = string | number | null | boolean | undefined> =
  | T
  | Record<string, T>
  | T[];

updateData(
  data: Cloneable,
  updateDataType: UpdateDataType,
  callback?: () => void,
): void
```

##### 3.4.2 updateGlobalProps

[See details](/api/lynx-api/main-thread/lynx-global-props)

```ts
updateGlobalProps(data: Cloneable): void;
```

##### 3.4.3 sendGlobalEvent

[See details](/api/lynx-native-api/lynx-view/send-global-event)

```ts
sendGlobalEvent(eventName: string, params: Cloneable[]): void;
```

#### 3.5 Width and Height

:::note
The internal layout of lynx-view will be forced out of the external layout flow
:::

We will force all lynx-view elements to apply [CSS Containment](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_containment).

That is, by default, you need to set a width and height for lynx-view. The width and height can be allocated by `flex-grow` or specified as a percentage, but cannot be "stretched". Setting width and height is a strongly recommended practice and also a best practice for performance.

In some cases where you really need the width or height to be determined by the content of lynx-view, you can set `height="auto"` or `width="auto"` to enable the automatic width/height listener. In this case, the internal layout of lynx-view remains independent of the external layout flow.

### 3.2 Compatibility

The recommended configuration is: **Chrome > 118, Safari > 18, Firefox NSR**

If you want to support browsers with Chrome < 118 and Safari < 18, you need to do the following:

1. Import the compatibility plugin:

```ts
import '@lynx-js/web-elements-compat/LinearContainer';
```

2. Additionally compile the `@lynx-js` dependencies. If your project uses Rsbuild, modify the configuration as follows:

```ts
// rsbuild.config.ts
export default {
  source: {
    include: [/@lynx-js/],
  },
};
```

### 3.3 FAQ

#### 3.3.1 Runtime error: `Uncaught SecurityError: Failed to construct 'Worker': Script at 'xxx' cannot be accessed from origin 'xxx'.`

This is because Worker loading remote scripts needs to comply with the [Same-Origin Policy](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy), and the JS resources of the project are generally deployed on CDN, causing cross-origin issues.

This can be solved by introducing [remote-web-worker](https://github.com/jantimon/remote-web-worker):

```ts
// The import position must be before @lynx-js/web-core
import 'remote-web-worker';

import '@lynx-js/web-core';
import '@lynx-js/web-core/index.css';
import '@lynx-js/web-elements/all';
import '@lynx-js/web-elements/index.css';
document.body.innerHTML = `
<lynx-view
    style="height:100vh; width:100vw;"
    url="http://localhost:3000/main/index.main.bundle"
>
</lynx-view>`;
```

#### 3.3.2 Performance Optimization

We provide an RSBuild plugin for performance optimization. You can introduce [this plugin](https://www.npmjs.com/package/@lynx-js/web-platform-rsbuild-plugin) in your web project.
